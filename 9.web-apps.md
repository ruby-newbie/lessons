# 9. Web apps

## Чему научитесь:

- понимать, как работают веб-приложения
- писать простые веб-приложение с бэкендом

## Материалы для изучения

[Http-запросы от А до Я](https://otus.ru/journal/http-zaprosy-ot-a-do-ya/)  
[Http-протокол](https://practicum.yandex.ru/blog/chto-takoe-protokol-http/)  
[Что такое веб-сервер и как он работает](https://practicum.yandex.ru/blog/chto-takoe-veb-server-i-kak-rabotaet/)  
[Работа с сетью (RubyRush)](https://rubyrush.ru/steps/network)

## Вопросы

- Структура HTTP-запроса
- Основные методы HTTP (get, post, put, patch, delete)
- Http-заголовки
- Статусы ответов

- что происходит, когда мы набираем адрес сайта в адресной строке (и сабмитим)
- чем отличается бэкенд от фронтенда

- что такое api?

## Практика

### http-запросы

Посмотрим информацию об http-запросе в браузере:

- Right click and select ‘Inspect’ to open developer tools.
- Select the network tab and refresh or reload the page.
- Select any HTTP request from the left panel and the header will be displayed on the right.

Обратите внимание на заголовки запроса, заголовки ответа, вкладку с телом ответа.

#### curl

Посмотрим информацию о запросе, к-й сделаем через curl.

[curl](https://curl.se/) - command line tool and library for transferring data with URLs

Установка:

```bash
sudo apt-get install curl
```

Запрос
```
curl github.com
```

Подробнее (verbose):

```bash
curl -v ваш_урл
```

Подробнее + follow redirects:

```bash
curl -Lv ваш_урл
```

Наша программа на руби тоже может работать в кач-ве клиента.
Пример с помощью стандартной библиотеки `net/http`

```ruby
require 'uri'
require 'net/http'
require 'json'

uri = URI('https://api.thecatapi.com/v1/images/search?size=med&mime_types=jpg&format=json&has_breeds=true&order=RANDOM&page=0&limit=1')
res = Net::HTTP.get_response(uri)
puts res.body if res.is_a?(Net::HTTPSuccess)

json = JSON.parse(res.body)
cat = json&.first.dig("url") # аналогично json.first["url"], но с проверкой на nil

if cat
  puts "Ваш котик по адресу: #{cat}"
else
  puts "Ваш котик не найден"
end
```

Нашему приложению может понадобиться запрашивать данные у других веб-приложений (обычно по API). В этом примере мы получаем файл в формает json в ответе, но с помощью http запросов мы можем получать и другие форматы.  

[API для получения котиков](https://thecatapi.com/).

### Embedded Ruby

Пока для наших приложений мы будем формировать html, чтобы сразу показывать его в браузере.
Но html - статический формат.

Как нам "вставить" руби-код в html-документ? Теоретически, мы можем формировать html в руби, как в [примере](https://github.com/ruby-newbie/lessons/blob/main/code/todo_server/todo.ru), но это неудобно.

Erb - templating system for Ruby.  

Выполним и разберём код из [примера](https://webapps-for-beginners.rubymonstas.org/erb/rendering_erb.html).

Обычно шаблон будет храниться в отдельном файле, т.о. нам будет удобнее с ним работать.

binding - текущий контекст исполнения, он будет содержать переменные, методы и т.п., доступные в данный момент.

[binding](https://webapps-for-beginners.rubymonstas.org/erb/bindings.html).

Теперь нужно сделать так, чтобы наш html был доступен в браузере для наших пользователей (пока локально, у вас на компьютере :)

### Rack-приложение

Rack provides a minimal, modular, and adaptable interface for developing web applications in Ruby. By wrapping HTTP requests and responses in the simplest way possible, it unifies and distills the bridge between web servers, web frameworks, and web application into a single method call.

Создадим файл config.ru

- пишем простое приложение (hello world)

- нужно добавить веб-сервер (puma, thin)

- Puma/Thin look for a config.ru file in the same directory, and uses that to launch our web application.

(А могли бы rackup file.ru или bundle exec rackup file.ru)

The answer is that our application follows the Rack protocol, and they all are rack-compliant web servers (puma, thin).

- метод `call`
- принимает объект `env` (representing the HTTP request, ruby hash)
- возвращает массив из трёх значений:  the status code, the headers, and the response.

Пример:

```ruby
class App
   def call(env)
     headers = { 'Content-Type' => 'text/html' }

     response = ['<h1>Greetings from Rack!!</h1>']

     [200, headers, response]
   end
end
```

[Пример проекта rack hello world](https://github.com/ruby-newbie/lessons/tree/main/code/rack)  

Напишем более осмысленное rack-приложение.  
Возьмите код программы [Magic Ball](https://rubyrush.ru/steps/magic-ball), которую мы писали на одной из прошлых занятий.  
Перенесём код в наше rack-приложение. Таким образом, пользователи смогут заходить на наш сайт и получать ответ на вопрос, который они задумали, от магического шара.  

На этом этапе вы можете оформить код по-разному:
- "положить" код получения ответа от шара прямо в код метода `call`
- выделить код в отдельный метод
- создать класс `MagicBall`, положить логику туда и подключить в файле `config.ru` с помощью require

Можно сделать html немного красивее. Я подключила фреймворк [simple.css](https://simplecss.org/) для минимальной красоты.

Мой вариант в [репозитории](https://github.com/ruby-newbie/magic-ball-rack)

Аналогично мы можем добавлять в наше приложение любой код, в т.ч. подключаться к базе данных, как на прошлом занятии, чтобы делать нужные фичи.

[Пример подключения базы данных и отображения информации на странице](https://github.com/ruby-newbie/lessons/blob/main/code/todo_server/todo.ru)

### Пишем приложение на фреймворке Sinatra

Прежде, чем попробовать самый популярный ruby-фреймворк Ruby on Rails и ORM ActiveRecord, попробуем поработать с другими.  
Это расширит кругозор и позволит лучше понимать, что происходит в веб-приложении.  

[Создадим приложение на основе тудулиста, который делали на прошлом занятии.  
Также будем использовать ORM Sequel, которая облегчит нам работу с базой данных.]

Создайте отдельную директорию для проекта, в ней создайте Gemfile:

```Gemfile
source "https://rubygems.org"

gem "rackup"
gem "sinatra"
```

Установите гемы: `bundle install`  
------
Для начала напишем hello world на синатре.

```ruby
require 'sinatra'

get '/' do
  'Hello world!'
end

```

Запуск:
```bash
bundle exec ruby todo.rb
```

Пробуем приём параметров от пользователя:

get


### Подключим gem rerun

чтобы каждый раз не перезапускать приложение вручную.  
Добавьте в Gemfile `gem "rerun"`

Запуск приложения:

```bash
rerun bundle exec ruby todo.rb
```

### Подключаем шаблонизатор erb

(который мы уже пробовали)

Добавим:

```Gemfile
gem "erb"
```

Создадим в проекте папку views и в ней layout.erb и index.erb  
Рендерить будем - `erb :index`

Напишем html шаблона layout (пример).
Вместо `yield` будет подставляться конкретный шаблон, к-й мы будем рендерить (здесь - index)

Создадим [форму](https://www.w3schools.com/html/html_forms.asp) для создания дела.

Action формы поставим `/tasks/create`, создадим соответствующее действие в основном файле:

(добавьте поле ввода названия дела и кнопку submit)

```ruby
post '/tasks/create' do
  # ... тут будем создавать события
  # пока выведем params
  params.inspect
end
```

Дальше нам нужно написать код для вывода списка дел из бд и создания. Для этого используем базу данных sqlite.

#### Синатра + субд

Добавьте гемы в гемфайл:

```Gemfile
gem "sqlite3"
gem "sequel"
```

Установите (`bundle install`).

Напишем сиды для базы данных (создание базы данных и таблицы, если их ещё нет, заполнение данными).

Возьмите короткий пример из документации [sequel](https://github.com/jeremyevans/sequel?tab=readme-ov-file#a-short-example-)
и напишите аналогичный для заполнения нашей бд.

(Сравните с `CREATE TABLE` из sql)

Подключим бд к приложению:

```ruby
require 'sinatra'
require 'sequel'

DB_PATH = 'sqlite://tasks.db'
DB = Sequel.connect(DB_PATH)
```

Выведем задачи в цикле в `index.erb` (коллекция дел будет в `DB[:tasks]`)

Пропишем создание дел в блоке `post '/tasks/create' do`

```ruby
DB[:tasks].insert(...)
```

Отметим дела сделанными:

```ruby
DB[:tasks].update(...)
```


### Дополнительно

- удаление дел


## Дополнительные материалы

[Definitive guide to rack](https://www.writesoftwarewell.com/definitive-guide-to-rack/) - подробная статья о rack - что это, зачем нужен, и как с ним работают фреймворки.

[Туториал по синатре от Railsgirls](https://guides.railsgirls.com/sinatra-app)
[Туториал: пишем блог на фреймворке roda](https://mrcook.uk/simple-roda-blog-tutorial)  
[API для вашего проекта](https://dev.to/mukeshkuiry/12-free-and-fun-api-for-your-next-project-5eem)  

## Дополнительные задания

[Упражнение по erb](https://webapps-for-beginners.rubymonstas.org/exercises/mailbox_erb.html)
Придумайте и напишите своё приложение с API из списка или других открытых API.
